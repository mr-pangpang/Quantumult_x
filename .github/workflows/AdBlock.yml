name: AdBlock Rule Sync  # æ›´æ¸…æ™°çš„å·¥ä½œæµåç§°ï¼Œæ˜ç¡®ç”¨é€”
on:
  schedule:
    - cron: "0 0 * * 1"  # æ¯å‘¨ä¸€ UTC 0 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 8 ç‚¹ï¼‰è‡ªåŠ¨æ‰§è¡Œ
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆä¿ç•™ä¾¿æ·è°ƒè¯•å…¥å£ï¼‰
    inputs:
      debug_mode:  # æ–°å¢è°ƒè¯•æ¨¡å¼è¾“å…¥ï¼ŒæŒ‰éœ€å¼€å¯è¯¦ç»†æ—¥å¿—
        description: "å¼€å¯è°ƒè¯•æ¨¡å¼ï¼ˆæ‰“å°å®Œæ•´é¡µé¢å†…å®¹ï¼‰"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  sync-adblock-rule:  # ä»»åŠ¡åæ›´è¯­ä¹‰åŒ–ï¼Œæ›¿ä»£åŸ"download-and-save"
    runs-on: ubuntu-latest
    env:
      # ç¯å¢ƒå˜é‡é›†ä¸­ç®¡ç†ï¼ˆåç»­ä¿®æ”¹é“¾æ¥/è·¯å¾„åªéœ€æ”¹è¿™é‡Œï¼Œä¸ç”¨æœä»£ç ï¼‰
      RULE_URL: "https://whatshub.top/rule/AntiAD.list"
      TARGET_REPO: "dpdisk/quantumult_x"
      TARGET_PATH: "filter/AdBlock"  # ç›®æ ‡ä»“åº“ä¸­æ–‡ä»¶çš„æœ€ç»ˆè·¯å¾„
      USER_AGENT: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
    
    steps:
      - name: æ‹‰å–å½“å‰ä»“åº“ä»£ç ï¼ˆåŸºç¡€æ­¥éª¤ï¼‰
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # ä¿æŒåŸå®‰å…¨é…ç½®

      - name: ç¼“å­˜Playwrightä¾èµ–ï¼ˆæé€Ÿ+å‡å°‘é‡å¤å®‰è£…ï¼‰
        uses: actions/cache@v3  # ç”¨å®˜æ–¹ç¼“å­˜åŠ¨ä½œï¼Œé¿å…æ¯æ¬¡é‡æ–°è£…æµè§ˆå™¨ï¼ˆèŠ‚çœ30+ç§’ï¼‰
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright/  # Playwrightæµè§ˆå™¨ç¼“å­˜è·¯å¾„
            ~/.local/lib/python3.12/site-packages/  # Pythonä¾èµ–ç¼“å­˜è·¯å¾„
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}  # æŒ‰ç³»ç»Ÿ+ä¾èµ–ç‰ˆæœ¬ç¼“å­˜
          restore-keys: |
            ${{ runner.os }}-playwright-  # ç¼“å­˜æœªå‘½ä¸­æ—¶ï¼Œå¤ç”¨åŒç³»ç»Ÿæ—§ç¼“å­˜

      - name: å®‰è£…PlaywrightåŠç³»ç»Ÿä¾èµ–ï¼ˆé€‚é…Ubuntu 24.04ï¼Œå¤±è´¥é‡è¯•ï¼‰
        run: |
          # 1. å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆå¢åŠ é‡è¯•é€»è¾‘ï¼Œåº”å¯¹ç½‘ç»œæ³¢åŠ¨ï¼‰
          retry=3  # æœ€å¤šé‡è¯•3æ¬¡
          while [ $retry -gt 0 ]; do
            sudo apt-get update && sudo apt-get install -y python3-pip libnss3 libxi6 libxrender1 libxss1 libasound2t64 && break
            retry=$((retry-1))
            echo "ä¾èµ–å®‰è£…å¤±è´¥ï¼Œ$retry æ¬¡é‡è¯•æœºä¼š..."
            sleep 2  # é‡è¯•é—´éš”2ç§’ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
          done
          if [ $retry -eq 0 ]; then exit 1; fi  # 3æ¬¡å¤±è´¥åˆ™ç»ˆæ­¢ï¼Œé¿å…æ— æ•ˆå¾ªç¯

          # 2. å®‰è£…Playwrightï¼ˆä»…ç¼“å­˜æœªå‘½ä¸­æ—¶æ‰§è¡Œï¼ŒèŠ‚çœæ—¶é—´ï¼‰
          if [ "${{ steps.playwright-cache.outputs.cache-hit }}" != "true" ]; then
            pip3 install --upgrade pip  # å‡çº§pipï¼Œé¿å…ç‰ˆæœ¬å…¼å®¹é—®é¢˜
            pip3 install playwright
            playwright install --with-deps  # è‡ªåŠ¨è¡¥å…¨æµè§ˆå™¨åŠä¾èµ–
          fi

          # 3. æ‰“å°æµè§ˆå™¨è·¯å¾„ï¼ˆè°ƒè¯•ç”¨ï¼Œæ¸…æ™°å±•ç¤ºå®é™…ä½¿ç”¨çš„Chromeä½ç½®ï¼‰
          echo -e "\n=== å·²æ‰¾åˆ°çš„æµè§ˆå™¨å¯æ‰§è¡Œæ–‡ä»¶ ==="
          find ~/.cache/ms-playwright/ -name "headless_shell" -o -name "chrome" 2>/dev/null || echo "æœªæ‰¾åˆ°æµè§ˆå™¨ï¼ˆç¼“å­˜å¼‚å¸¸ï¼‰"

      - name: ä¸‹è½½AdBlockè§„åˆ™ï¼ˆPlaywrightæ–¹æ¡ˆï¼Œå¸¦é‡è¯•+è¯¦ç»†æ—¥å¿—ï¼‰
        run: |
          cat > download.py << EOF
          from playwright.sync_api import sync_playwright
          import os
          import subprocess
          import time

          def find_chrome_path():
              """è‡ªåŠ¨æŸ¥æ‰¾Chrome/headless_shellè·¯å¾„ï¼ˆå…¼å®¹ä¸åŒPlaywrightç‰ˆæœ¬ï¼‰"""
              for target in ["headless_shell", "chrome"]:
                  try:
                      # ç”¨subprocessæ‰§è¡Œfindå‘½ä»¤ï¼Œæ•è·è¾“å‡ºï¼ˆå¿½ç•¥æ— å…³é”™è¯¯ï¼‰
                      result = subprocess.check_output(
                          ["find", "$HOME/.cache/ms-playwright/", "-name", target],
                          stderr=subprocess.STDOUT
                      ).decode("utf-8", errors="ignore").strip()  # å…¼å®¹éUTF-8å­—ç¬¦
                      if result:
                          return result.split("\n")[0]  # è¿”å›ç¬¬ä¸€ä¸ªæœ‰æ•ˆè·¯å¾„
                  except (subprocess.CalledProcessError, FileNotFoundError):
                      continue
              raise Exception("âŒ æœªæ‰¾åˆ°Chrome/headless_shellï¼ˆæµè§ˆå™¨æœªæ­£ç¡®å®‰è£…ï¼‰")

          def download_rule(url, user_agent, debug_mode):
              """ä¸‹è½½è§„åˆ™æ ¸å¿ƒé€»è¾‘ï¼ˆå¸¦é‡è¯•+è°ƒè¯•æ—¥å¿—ï¼‰"""
              max_retries = 2  # ä¸‹è½½å¤±è´¥é‡è¯•2æ¬¡ï¼ˆåº”å¯¹ç½‘ç»œæ³¢åŠ¨ï¼‰
              retry_count = 0

              while retry_count <= max_retries:
                  try:
                      with sync_playwright() as p:
                          # 1. å¯åŠ¨Chromeï¼ˆé€‚é…æœåŠ¡å™¨æ— ç•Œé¢ç¯å¢ƒï¼‰
                          chrome_path = find_chrome_path()
                          print(f"âœ… æ‰¾åˆ°Chromeè·¯å¾„ï¼š{chrome_path}")
                          
                          browser = p.chromium.launch(
                              headless=True,
                              args=["--no-sandbox", "--disable-dev-shm-usage", "--disable-gpu"],  # åŠ --disable-gpué€‚é…æ— å¤´ç¯å¢ƒ
                              executable_path=chrome_path,
                              timeout=20000  # æµè§ˆå™¨å¯åŠ¨è¶…æ—¶20ç§’
                          )

                          # 2. æ–°å»ºé¡µé¢+è®¾ç½®è¯·æ±‚å¤´ï¼ˆæ¨¡æ‹ŸçœŸå®æµè§ˆå™¨ï¼‰
                          page = browser.new_page(user_agent=user_agent)
                          # ç¦ç”¨JavaScriptï¼ˆå¯é€‰ï¼šå‡å°‘åçˆ¬å¹²æ‰°ï¼Œè§„åˆ™é¡µé¢é€šå¸¸æ— éœ€JSï¼‰
                          page.context.add_init_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
                          
                          # 3. è®¿é—®è§„åˆ™é“¾æ¥ï¼ˆå¸¦è¶…æ—¶æ§åˆ¶ï¼‰
                          print(f"ğŸ”„ ç¬¬{retry_count+1}æ¬¡è®¿é—®é“¾æ¥ï¼š{url}")
                          page.goto(url, timeout=30000)  # é¡µé¢åŠ è½½è¶…æ—¶30ç§’
                          time.sleep(1)  # ç­‰å¾…1ç§’ï¼Œç¡®ä¿å†…å®¹åŠ è½½å®Œæˆï¼ˆåº”å¯¹åŠ¨æ€æ¸²æŸ“ï¼‰

                          # 4. è·å–å¹¶ä¿å­˜é¡µé¢å†…å®¹ï¼ˆç”¨äºŒè¿›åˆ¶å†™é¿å…ç¼–ç é”™è¯¯ï¼‰
                          page_content = page.content()
                          with open("AdBlock", "wb") as f:  # äºŒè¿›åˆ¶å†™å…¥ï¼Œå…¼å®¹æ‰€æœ‰å­—ç¬¦ç¼–ç 
                              f.write(page_content.encode("utf-8", errors="replace"))
                          browser.close()
                          print("ğŸ”š æµè§ˆå™¨å·²å…³é—­ï¼Œå¼€å§‹éªŒè¯æ–‡ä»¶...")

                          # 5. è°ƒè¯•æ—¥å¿—ï¼šæ‰“å°å…³é”®ä¿¡æ¯ï¼ˆæŒ‰éœ€å¼€å¯ï¼‰
                          file_size = os.path.getsize("AdBlock")
                          print(f"ğŸ“Š æ–‡ä»¶ä¿¡æ¯ï¼šå¤§å°={file_size}å­—èŠ‚ | å‰200å­—ç¬¦ï¼š{page_content[:200] if len(page_content)>=200 else page_content}")
                          if debug_mode == "true":
                              # è°ƒè¯•æ¨¡å¼ï¼šä¿å­˜å®Œæ•´å†…å®¹å¿«ç…§ï¼ˆæ–¹ä¾¿å®šä½é—®é¢˜ï¼‰
                              with open("debug_content.txt", "w", encoding="utf-8", errors="ignore") as f:
                                  f.write(f"=== è°ƒè¯•å¿«ç…§ï¼ˆ{time.strftime('%Y-%m-%d %H:%M:%S')}ï¼‰===\n")
                                  f.write(f"URL: {url}\nUser-Agent: {user_agent}\nFile Size: {file_size}å­—èŠ‚\n")
                                  f.write(f"Full Content:\n{page_content}")
                              print("ğŸ“„ è°ƒè¯•å¿«ç…§å·²ä¿å­˜åˆ° debug_content.txt")

                          # 6. å®½æ¾ä¸”ä¸¥è°¨çš„æ–‡ä»¶æ ¡éªŒï¼ˆé¿å…æ— æ•ˆå†…å®¹ï¼‰
                          if file_size < 100:
                              raise Exception(f"âŒ æ–‡ä»¶è¿‡å°ï¼ˆ{file_size}å­—èŠ‚ï¼‰ï¼Œå¯èƒ½æ˜¯é”™è¯¯é¡µé¢")
                          # æ ¡éªŒè§„åˆ™ç‰¹å¾ï¼ˆè¦†ç›–99% AdBlockè§„åˆ™æ ¼å¼ï¼‰
                          content_sample = page_content[:500].lower()  # è½¬å°å†™ï¼Œé¿å…å¤§å°å†™é—®é¢˜
                          rule_features = ["#", ".", "^", "||", "!", "/"]  # æ‰©å±•ç‰¹å¾ï¼šæ³¨é‡Šã€åŸŸåã€è§„åˆ™ç¬¦ã€æ„Ÿå¹å·ï¼ˆè§„åˆ™æè¿°ï¼‰ã€è·¯å¾„ç¬¦
                          if not any(feature in content_sample for feature in rule_features):
                              raise Exception(f"âŒ æ–‡ä»¶æ— è§„åˆ™ç‰¹å¾ï¼ˆå‰500å­—ç¬¦ä¸å«{rule_features}ï¼‰ï¼Œå†…å®¹å¯èƒ½æ— æ•ˆ")

                          print(f"âœ… ä¸‹è½½æˆåŠŸï¼æ–‡ä»¶å¤§å°ï¼š{file_size}å­—èŠ‚ï¼ˆçº¦{file_size/1024:.2f}KBï¼‰")
                          return  # æˆåŠŸåˆ™é€€å‡ºé‡è¯•å¾ªç¯

                  except Exception as e:
                      retry_count += 1
                      print(f"âŒ ç¬¬{retry_count}æ¬¡å°è¯•å¤±è´¥ï¼š{str(e)[:100]}...")  # æ‰“å°é”™è¯¯å‰100å­—ç¬¦ï¼ˆé¿å…æ—¥å¿—è¿‡é•¿ï¼‰
                      if retry_count > max_retries:
                          raise Exception(f"âŒ æ‰€æœ‰{max_retries+1}æ¬¡å°è¯•å‡å¤±è´¥ï¼Œç»ˆæ­¢ä»»åŠ¡") from e
                      time.sleep(3)  # é‡è¯•é—´éš”3ç§’ï¼Œå‡å°‘æœåŠ¡å™¨å‹åŠ›

          # ä¸»æ‰§è¡Œé€»è¾‘ï¼ˆè¯»å–ç¯å¢ƒå˜é‡+è°ƒè¯•æ¨¡å¼ï¼‰
          if __name__ == "__main__":
              download_rule(
                  url="${{ env.RULE_URL }}",
                  user_agent="${{ env.USER_AGENT }}",
                  debug_mode="${{ github.event.inputs.debug_mode }}"
              )
          EOF

          # æ‰§è¡Œä¸‹è½½è„šæœ¬ï¼ˆæ•è·å¼‚å¸¸ï¼Œç¡®ä¿é”™è¯¯æ—¥å¿—æ¸…æ™°ï¼‰
          python3 download.py || (echo "âŒ ä¸‹è½½è„šæœ¬æ‰§è¡Œå¤±è´¥" && exit 1)

      - name: åŒæ­¥è§„åˆ™åˆ°ç›®æ ‡ä»“åº“ï¼ˆå®‰å…¨+å®¹é”™ï¼‰
        env:
          # ç”¨ç¯å¢ƒå˜é‡éšè—å¯†é’¥å¼•ç”¨ï¼ˆé¿å…æ˜æ–‡æš´éœ²ï¼Œç¬¦åˆå®‰å…¨æœ€ä½³å®è·µï¼‰
          GITHUB_TOKEN: ${{ secrets.PANGPANG }}
        run: |
          # 1. å®šä¹‰ç›®æ ‡ä»“åº“åœ°å€ï¼ˆç”¨å¯†é’¥æ‹¼æ¥ï¼Œé¿å…æ˜æ–‡URLï¼‰
          TARGET_REPO_URL="https://${GITHUB_TOKEN}@github.com/${{ env.TARGET_REPO }}.git"
          LOCAL_TARGET_DIR="target-repo"  # æœ¬åœ°ä¸´æ—¶ç›®å½•ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰

          # 2. å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆå®¹é”™ï¼šä»“åº“ä¸å­˜åœ¨åˆ™åˆå§‹åŒ–ï¼‰
          echo -e "\nğŸ”„ åŒæ­¥åˆ°ç›®æ ‡ä»“åº“ï¼š${{ env.TARGET_REPO }}"
          if ! git clone -b main --single-branch "$TARGET_REPO_URL" "$LOCAL_TARGET_DIR"; then
              echo "âš ï¸  ä»“åº“æœªæ‰¾åˆ°ï¼Œåˆå§‹åŒ–æ–°ä»“åº“"
              mkdir -p "$LOCAL_TARGET_DIR"
              cd "$LOCAL_TARGET_DIR" || exit 1
              git init
              git remote add origin "$TARGET_REPO_URL"
              git checkout -b main
              cd ..
          fi

          # 3. ç§»åŠ¨è§„åˆ™æ–‡ä»¶ï¼ˆç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨ï¼‰
          mkdir -p "$LOCAL_TARGET_DIR/$(dirname ${{ env.TARGET_PATH }})"  # è‡ªåŠ¨åˆ›å»ºçˆ¶ç›®å½•ï¼ˆé¿å…è·¯å¾„ä¸å­˜åœ¨é”™è¯¯ï¼‰
          mv -f AdBlock "$LOCAL_TARGET_DIR/${{ env.TARGET_PATH }}"  # -f è¦†ç›–æ—§æ–‡ä»¶ï¼ˆé¿å…æƒé™é—®é¢˜ï¼‰
          echo "âœ… è§„åˆ™æ–‡ä»¶å·²ç§»åŠ¨åˆ°ï¼š$LOCAL_TARGET_DIR/${{ env.TARGET_PATH }}"

          # 4. æäº¤å¹¶æ¨é€å˜æ›´ï¼ˆå®¹é”™ï¼šæ— å˜æ›´åˆ™è·³è¿‡ï¼‰
          cd "$LOCAL_TARGET_DIR" || exit 1
          git config --global user.name "GitHub Actions [AdBlock Sync]"  # æ˜ç¡®æäº¤è€…èº«ä»½
          git config --global user.email "actions-adblock-sync@github.com"
          
          git add "${{ env.TARGET_PATH }}"
          if git diff --cached --quiet; then  # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
              echo "â„¹ï¸  æ— æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
              exit 0
          fi

          # æäº¤ä¿¡æ¯å¸¦æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰+ ç‰ˆæœ¬æç¤º
          COMMIT_TIME=$(date -d "+8 hours" +'%Y-%m-%d %H:%M:%S')  # è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
          git commit -m "Sync AdBlock rule | Update time: $COMMIT_TIME | Source: ${{ env.RULE_URL }}"
          
          # æ¨é€ï¼ˆå¸¦é‡è¯•ï¼Œåº”å¯¹ç½‘ç»œæ³¢åŠ¨ï¼‰
          retry=2
          while [ $retry -gt 0 ]; do
              if git push origin main; then
                  echo "âœ… æˆåŠŸæ¨é€åˆ°ç›®æ ‡ä»“åº“ï¼š${{ env.TARGET_REPO }}"
                  break
              fi
              retry=$((retry-1))
              echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œ$retry æ¬¡é‡è¯•æœºä¼š..."
              sleep 2
          done
          if [ $retry -eq 0 ]; then
              echo "âŒ æ¨é€å¤±è´¥ï¼Œæ‰€æœ‰é‡è¯•æœºä¼šç”¨å°½"
              exit 1
          fi
