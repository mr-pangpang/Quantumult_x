name: AdBlock
on:
  schedule:
    - cron: "0 0 * * 1"  # 每周一 UTC 0 点（北京时间 8 点）自动执行
  workflow_dispatch:  # 支持手动触发

jobs:
  download-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取当前仓库代码
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: 安装Playwright及Chrome（适配Ubuntu 24.04）
        run: |
          # 安装兼容系统的依赖包（适配最新Ubuntu）
          sudo apt-get update && sudo apt-get install -y python3-pip libnss3 libxi6 libxrender1 libxss1 libasound2t64
          # 安装Playwright并自动补全浏览器及依赖
          pip3 install playwright
          playwright install --with-deps
          # 打印Chrome路径（方便调试）
          echo "=== 已找到的浏览器可执行文件 ==="
          find /home/runner/.cache/ms-playwright/ -name "headless_shell" -o -name "chrome" 2>/dev/null

      - name: 用Playwright获取页面内容（替代监听下载，解决超时问题）
        run: |
          cat > download.py << EOF
          from playwright.sync_api import sync_playwright
          import os
          import subprocess

          def find_chrome_path():
              # 搜索Chrome/headless_shell路径（兼容不同版本）
              for target in ["headless_shell", "chrome"]:
                  try:
                      result = subprocess.check_output(
                          ["find", "/home/runner/.cache/ms-playwright/", "-name", target],
                          stderr=subprocess.STDOUT
                      ).decode().strip()
                      if result:
                          return result.split("\n")[0]
                  except subprocess.CalledProcessError:
                      continue
              raise Exception("未找到Chrome/headless_shell！")

          with sync_playwright() as p:
              # 1. 找到并启动Chrome
              chrome_path = find_chrome_path()
              print(f"✅ 已找到Chrome路径：{chrome_path}")
              browser = p.chromium.launch(
                  headless=True,
                  args=["--no-sandbox", "--disable-dev-shm-usage"],  # 适配服务器环境
                  executable_path=chrome_path
              )

              # 2. 新建页面+访问链接（模拟浏览器打开页面）
              page = browser.new_page(
                  user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
              )
              print("🔄 正在访问链接...")
              page.goto("https://whatshub.top/rule/AntiAD.list", timeout=30000)  # 30秒超时控制

              # 3. 关键修复：直接获取页面内容（而非等下载事件），保存为AdBlock文件
              # （和浏览器打开链接后显示文本、手动复制保存的逻辑一致）
              page_content = page.content()  # 获取页面所有内容（规则文本）
              with open("AdBlock", "w", encoding="utf-8") as f:
                  f.write(page_content)
              browser.close()
              print("🔚 浏览器已关闭，开始验证文件...")

              # 4. 验证文件有效性（确保不是空内容/错误页面）
              if not os.path.exists("AdBlock"):
                  raise Exception("❌ 失败：未生成AdBlock文件")
              file_size = os.path.getsize("AdBlock")
              if file_size < 100:  # 规则文件至少几百字节，排除极小错误页面
                  raise Exception(f"❌ 失败：文件过小（{file_size}字节），可能是错误页面")
              # 额外验证：检查内容是否包含规则特征（比如广告拦截规则常见的"||"符号）
              with open("AdBlock", "r", encoding="utf-8") as f:
                  content_sample = f.read(100)  # 读前100字符判断
                  if "||" not in content_sample:  # "||"是广告规则常用前缀（如||example.com^）
                      raise Exception("❌ 失败：文件内容不是AdBlock规则（未找到规则特征）")

              print(f"✅ 成功！文件大小：{file_size} 字节（约 {file_size/1024:.2f} KB）")
          EOF
          # 执行脚本
          python3 download.py

      - name: 检查dpdisk/quantumult_x仓库是否存在
        id: check_repo
        run: |
          RESPONSE=$(curl -s -w "%{http_code}" -H "Authorization: token ${{ secrets.PANGPANG }}" "https://api.github.com/repos/dpdisk/quantumult_x")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          echo "repo_exists=$([ "$HTTP_CODE" -eq 200 ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

      - name: 若仓库不存在则创建
        if: steps.check_repo.outputs.repo_exists == 'false'
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.PANGPANG }}" -H "Content-Type: application/json" -d '{"name":"quantumult_x","auto_init":false,"visibility":"public"}' "https://api.github.com/user/repos"

      - name: 克隆dpdisk/quantumult_x仓库
        run: |
          git clone -b main --single-branch https://${{ secrets.PANGPANG }}@github.com/dpdisk/quantumult_x.git target-repo || (mkdir -p target-repo && cd target-repo && git init && git remote add origin https://${{ secrets.PANGPANG }}@github.com/dpdisk/quantumult_x.git && git checkout -b main)

      - name: 移动文件到目标仓库根目录
        run: |
          mkdir -p target-repo/filter
          mv AdBlock target-repo/filter/
          echo "文件已移动到：target-repo/filter/AdBlock"

      - name: 提交并推送dpdisk仓库变更
        run: |
          cd target-repo
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add filter/AdBlock
          CURRENT_TIME=$(date -d "+8 hours" +'%Y-%m-%d %H:%M:%S')  # 用北京时间作为提交时间
          git commit -m "updatetime $CURRENT_TIME" || echo "无文件变更，无需提交"
          git push https://${{ secrets.PANGPANG }}@github.com/dpdisk/quantumult_x.git HEAD:main
