# åªä¿®æ”¹â€œç”¨PlaywrightèŽ·å–é¡µé¢å†…å®¹â€æ­¥éª¤ï¼Œå…¶ä»–æ­¥éª¤å’Œæ–¹æ¡ˆAä¸€è‡´
- name: ç”¨PlaywrightèŽ·å–é¡µé¢å†…å®¹ï¼ˆä¿å­˜å®Œæ•´å†…å®¹ç”¨äºŽè°ƒè¯•ï¼‰
  run: |
    cat > download.py << EOF
    from playwright.sync_api import sync_playwright
    import os
    import subprocess

    def find_chrome_path():
        for target in ["headless_shell", "chrome"]:
            try:
                result = subprocess.check_output(
                    ["find", "/home/runner/.cache/ms-playwright/", "-name", target],
                    stderr=subprocess.STDOUT
                ).decode().strip()
                if result:
                    return result.split("\n")[0]
            except subprocess.CalledProcessError:
                continue
        raise Exception("æœªæ‰¾åˆ°Chrome/headless_shellï¼")

    with sync_playwright() as p:
        chrome_path = find_chrome_path()
        print(f"âœ… å·²æ‰¾åˆ°Chromeè·¯å¾„ï¼š{chrome_path}")
        browser = p.chromium.launch(
            headless=True,
            args=["--no-sandbox", "--disable-dev-shm-usage"],
            executable_path=chrome_path
        )
        page = browser.new_page(
            user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
        )
        print("ðŸ”„ æ­£åœ¨è®¿é—®é“¾æŽ¥...")
        page.goto("https://whatshub.top/rule/AntiAD.list", timeout=30000)

        # 1. ä¿å­˜å®Œæ•´å†…å®¹ï¼ˆä¸ç®¡æ˜¯å¦æœ‰æ•ˆï¼Œå…ˆä¿å­˜ä¸‹æ¥ï¼‰
        page_content = page.content()
        with open("AdBlock", "w", encoding="utf-8") as f:
            f.write(page_content)
        # 2. é¢å¤–ä¿å­˜â€œå†…å®¹å¿«ç…§â€åˆ°å½“å‰ä»“åº“ï¼ˆæ–¹ä¾¿åœ¨GitHubæŸ¥çœ‹å®žé™…å†…å®¹ï¼‰
        with open("content_snapshot.txt", "w", encoding="utf-8") as f:
            f.write(f"æ–‡ä»¶å¤§å°ï¼š{len(page_content)} å­—èŠ‚\n")
            f.write(f"å‰500å­—ç¬¦ï¼š\n{page_content[:500]}\n")
            f.write(f"å®Œæ•´å†…å®¹ï¼š\n{page_content}")
        
        browser.close()
        print("ðŸ”š å·²ä¿å­˜å†…å®¹å¿«ç…§ï¼ˆcontent_snapshot.txtï¼‰ï¼Œå¯åœ¨GitHubä»“åº“æŸ¥çœ‹")

        # 3. ç®€å•æ ¡éªŒï¼ˆåªçœ‹å¤§å°ï¼Œä¸æ‹¦å†…å®¹ï¼Œå…ˆç¡®ä¿å†…å®¹èƒ½ä¿å­˜ï¼‰
        if os.path.getsize("AdBlock") < 100:
            raise Exception(f"âŒ å¤±è´¥ï¼šæ–‡ä»¶è¿‡å°ï¼ˆ{os.path.getsize('AdBlock')}å­—èŠ‚ï¼‰")
        print(f"âœ… å†…å®¹å·²ä¿å­˜ï¼æ–‡ä»¶å¤§å°ï¼š{os.path.getsize('AdBlock')} å­—èŠ‚")
    EOF
    python3 download.py

# æ–°å¢žæ­¥éª¤ï¼šæŠŠå†…å®¹å¿«ç…§æŽ¨åˆ°å½“å‰ä»“åº“ï¼ˆæ–¹ä¾¿ä½ æŸ¥çœ‹ï¼‰
- name: æŽ¨é€å†…å®¹å¿«ç…§åˆ°å½“å‰ä»“åº“ï¼ˆç”¨äºŽè°ƒè¯•ï¼‰
  run: |
    git config --global user.name "GitHub Actions"
    git config --global user.email "actions@github.com"
    git add content_snapshot.txt
    git commit -m "add content snapshot for debug" || echo "æ— æ–°å¿«ç…§éœ€è¦æäº¤"
    git push origin HEAD
