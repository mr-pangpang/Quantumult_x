name: AdBlock
on:
  schedule:
    - cron: "0 0 * * 1"  # æ¯å‘¨ä¸€ UTC 0 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 8 ç‚¹ï¼‰è‡ªåŠ¨æ‰§è¡Œ
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  download-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–å½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: å®‰è£…PlaywrightåŠChromeï¼ˆé€‚é…Ubuntu 24.04ï¼‰
        run: |
          sudo apt-get update && sudo apt-get install -y python3-pip libnss3 libxi6 libxrender1 libxss1 libasound2t64
          pip3 install playwright
          playwright install --with-deps
          echo "=== å·²æ‰¾åˆ°çš„æµè§ˆå™¨å¯æ‰§è¡Œæ–‡ä»¶ ==="
          find /home/runner/.cache/ms-playwright/ -name "headless_shell" -o -name "chrome" 2>/dev/null

      - name: ç”¨Playwrightè·å–é¡µé¢å†…å®¹ï¼ˆé€‚é…è§„åˆ™ç‰¹å¾ï¼‰
        run: |
          cat > download.py << EOF
          from playwright.sync_api import sync_playwright
          import os
          import subprocess

          def find_chrome_path():
              for target in ["headless_shell", "chrome"]:
                  try:
                      result = subprocess.check_output(
                          ["find", "/home/runner/.cache/ms-playwright/", "-name", target],
                          stderr=subprocess.STDOUT
                      ).decode().strip()
                      if result:
                          return result.split("\n")[0]
                  except subprocess.CalledProcessError:
                      continue
              raise Exception("æœªæ‰¾åˆ°Chrome/headless_shellï¼")

          with sync_playwright() as p:
              # 1. å¯åŠ¨Chromeå¹¶è®¿é—®é“¾æ¥
              chrome_path = find_chrome_path()
              print(f"âœ… å·²æ‰¾åˆ°Chromeè·¯å¾„ï¼š{chrome_path}")
              browser = p.chromium.launch(
                  headless=True,
                  args=["--no-sandbox", "--disable-dev-shm-usage"],
                  executable_path=chrome_path
              )
              page = browser.new_page(
                  user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
              )
              print("ğŸ”„ æ­£åœ¨è®¿é—®é“¾æ¥...")
              page.goto("https://whatshub.top/rule/AntiAD.list", timeout=30000)

              # 2. ä¿å­˜é¡µé¢å†…å®¹ï¼ˆåŒæ—¶æ‰“å°å‰200å­—ç¬¦ï¼Œæ–¹ä¾¿è°ƒè¯•å†…å®¹ï¼‰
              page_content = page.content()
              with open("AdBlock", "w", encoding="utf-8") as f:
                  f.write(page_content)
              browser.close()
              print("ğŸ”š æµè§ˆå™¨å·²å…³é—­ï¼Œå¼€å§‹éªŒè¯æ–‡ä»¶...")
              print(f"ğŸ“„ æ–‡ä»¶å‰200å­—ç¬¦å†…å®¹ï¼š{page_content[:200]}")  # å…³é”®ï¼šæ‰“å°å†…å®¹ç‰‡æ®µï¼Œçœ‹å®é™…è·å–åˆ°å•¥

              # 3. å®½æ¾æ ¡éªŒï¼šåªè¦åŒ…å«"è§„åˆ™å¸¸è§å…ƒç´ "å°±è®¤ä¸ºæœ‰æ•ˆï¼ˆé€‚é…æ›´å¤šè§„åˆ™æ ¼å¼ï¼‰
              if not os.path.exists("AdBlock"):
                  raise Exception("âŒ å¤±è´¥ï¼šæœªç”ŸæˆAdBlockæ–‡ä»¶")
              file_size = os.path.getsize("AdBlock")
              if file_size < 100:
                  raise Exception(f"âŒ å¤±è´¥ï¼šæ–‡ä»¶è¿‡å°ï¼ˆ{file_size}å­—èŠ‚ï¼‰ï¼Œå¯èƒ½æ˜¯é”™è¯¯é¡µé¢")
              # æ›¿æ¢ç‰¹å¾ï¼šç”¨"#"ï¼ˆæ³¨é‡Šï¼‰ã€"."ï¼ˆåŸŸåï¼‰ã€"^"ï¼ˆè§„åˆ™ç»“æŸç¬¦ï¼‰ä¸­ä»»æ„ä¸€ä¸ªåˆ¤æ–­
              content_sample = page_content[:500]  # è¯»å‰500å­—ç¬¦åˆ¤æ–­
              if not any(char in content_sample for char in ["#", ".", "^"]):
                  raise Exception("âŒ å¤±è´¥ï¼šæ–‡ä»¶å†…å®¹æ— è§„åˆ™ç‰¹å¾ï¼ˆæ— #/.^ï¼‰ï¼Œå¯èƒ½æ˜¯é”™è¯¯é¡µé¢")

              print(f"âœ… æˆåŠŸï¼æ–‡ä»¶å¤§å°ï¼š{file_size} å­—èŠ‚ï¼ˆçº¦ {file_size/1024:.2f} KBï¼‰")
          EOF
          python3 download.py

      # åç»­ä»“åº“æ£€æŸ¥ã€å…‹éš†ã€æ¨é€æ­¥éª¤å’Œä¹‹å‰ä¸€è‡´ï¼ˆçœç•¥ï¼Œç›´æ¥ç”¨ä¹‹å‰çš„ä»£ç å³å¯ï¼‰
      - name: æ£€æŸ¥dpdisk/quantumult_xä»“åº“æ˜¯å¦å­˜åœ¨
        id: check_repo
        run: |
          RESPONSE=$(curl -s -w "%{http_code}" -H "Authorization: token ${{ secrets.PANGPANG }}" "https://api.github.com/repos/dpdisk/quantumult_x")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          echo "repo_exists=$([ "$HTTP_CODE" -eq 200 ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

      - name: è‹¥ä»“åº“ä¸å­˜åœ¨åˆ™åˆ›å»º
        if: steps.check_repo.outputs.repo_exists == 'false'
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.PANGPANG }}" -H "Content-Type: application/json" -d '{"name":"quantumult_x","auto_init":false,"visibility":"public"}' "https://api.github.com/user/repos"

      - name: å…‹éš†dpdisk/quantumult_xä»“åº“
        run: |
          git clone -b main --single-branch https://${{ secrets.PANGPANG }}@github.com/dpdisk/quantumult_x.git target-repo || (mkdir -p target-repo && cd target-repo && git init && git remote add origin https://${{ secrets.PANGPANG }}@github.com/dpdisk/quantumult_x.git && git checkout -b main)

      - name: ç§»åŠ¨æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“æ ¹ç›®å½•
        run: |
          mkdir -p target-repo/filter
          mv AdBlock target-repo/filter/
          echo "æ–‡ä»¶å·²ç§»åŠ¨åˆ°ï¼štarget-repo/filter/AdBlock"

      - name: æäº¤å¹¶æ¨é€dpdiskä»“åº“å˜æ›´
        run: |
          cd target-repo
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add filter/AdBlock
          CURRENT_TIME=$(date -d "+8 hours" +'%Y-%m-%d %H:%M:%S')
          git commit -m "updatetime $CURRENT_TIME" || echo "æ— æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤"
          git push https://${{ secrets.PANGPANG }}@github.com/dpdisk/quantumult_x.git HEAD:main
