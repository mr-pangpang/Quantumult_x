name: Gather
on:
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:
    inputs:
      debug_mode:
        description: "å¼€å¯è°ƒè¯•æ¨¡å¼ï¼ˆæ‰“å°å®Œæ•´é¡µé¢å†…å®¹ï¼‰"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  sync-Gather-rule:
    runs-on: ubuntu-latest
    env:
      RULE_URL: "https://tv.iill.top/m3u/Gather"
      TARGET_REPO: "dpdisk/quantumult_x"
      TARGET_PATH: "filter/Gather"
      USER_AGENT: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
    
    steps:
      - name: æ‹‰å–å½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: ç¼“å­˜Playwrightä¾èµ–
        uses: actions/cache@v3
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright/
            ~/.local/lib/python3.12/site-packages/
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: å®‰è£…PlaywrightåŠç³»ç»Ÿä¾èµ–
        run: |
          retry=3
          while [ $retry -gt 0 ]; do
            sudo apt-get update && sudo apt-get install -y python3-pip libnss3 libxi6 libxrender1 libxss1 libasound2t64 && break
            retry=$((retry-1))
            echo "ä¾èµ–å®‰è£…å¤±è´¥ï¼Œ$retry æ¬¡é‡è¯•æœºä¼š..."
            sleep 2
          done
          if [ $retry -eq 0 ]; then exit 1; fi

          if [ "${{ steps.playwright-cache.outputs.cache-hit }}" != "true" ]; then
            pip3 install --upgrade pip
            pip3 install playwright
            playwright install --with-deps
          fi

          echo -e "\n=== å·²æ‰¾åˆ°çš„æµè§ˆå™¨å¯æ‰§è¡Œæ–‡ä»¶ ==="
          find ~/.cache/ms-playwright/ -name "headless_shell" -o -name "chrome" 2>/dev/null || echo "æœªæ‰¾åˆ°æµè§ˆå™¨ï¼ˆç¼“å­˜å¼‚å¸¸ï¼‰"

      - name: ä¸‹è½½Gatherè§„åˆ™
        run: |
          cat > download.py << EOF
          from playwright.sync_api import sync_playwright
          import os
          import subprocess
          import time

          def find_chrome_path():
              for target in ["headless_shell", "chrome"]:
                  try:
                      result = subprocess.check_output(
                          ["find", "$HOME/.cache/ms-playwright/", "-name", target],
                          stderr=subprocess.STDOUT
                      ).decode("utf-8", errors="ignore").strip()
                      if result:
                          return result.split("\n")[0]
                  except (subprocess.CalledProcessError, FileNotFoundError):
                      continue
              raise Exception("âŒ æœªæ‰¾åˆ°Chrome/headless_shellï¼ˆæµè§ˆå™¨æœªæ­£ç¡®å®‰è£…ï¼‰")

          def download_rule(url, user_agent, debug_mode):
              max_retries = 2
              retry_count = 0

              while retry_count <= max_retries:
                  try:
                      with sync_playwright() as p:
                          chrome_path = find_chrome_path()
                          print(f"âœ… æ‰¾åˆ°Chromeè·¯å¾„ï¼š{chrome_path}")
                          
                          browser = p.chromium.launch(
                              headless=True,
                              args=["--no-sandbox", "--disable-dev-shm-usage", "--disable-gpu"],
                              executable_path=chrome_path,
                              timeout=20000
                          )

                          page = browser.new_page(user_agent=user_agent)
                          page.context.add_init_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
                          
                          print(f"ğŸ”„ ç¬¬{retry_count+1}æ¬¡è®¿é—®é“¾æ¥ï¼š{url}")
                          page.goto(url, timeout=30000)
                          time.sleep(1)

                          page_content = page.content()
                          with open("Gather", "wb") as f:
                              f.write(page_content.encode("utf-8", errors="replace"))
                          browser.close()
                          print("ğŸ”š æµè§ˆå™¨å·²å…³é—­ï¼Œå¼€å§‹éªŒè¯æ–‡ä»¶...")

                          file_size = os.path.getsize("Gather")
                          print(f"ğŸ“Š æ–‡ä»¶ä¿¡æ¯ï¼šå¤§å°={file_size}å­—èŠ‚ | å‰200å­—ç¬¦ï¼š{page_content[:200] if len(page_content)>=200 else page_content}")
                          if debug_mode == "true":
                              with open("debug_content.txt", "w", encoding="utf-8", errors="ignore") as f:
                                  f.write(f"=== è°ƒè¯•å¿«ç…§ï¼ˆ{time.strftime('%Y-%m-%d %H:%M:%S')}ï¼‰===\n")
                                  f.write(f"URL: {url}\nUser-Agent: {user_agent}\nFile Size: {file_size}å­—èŠ‚\n")
                                  f.write(f"Full Content:\n{page_content}")
                              print("ğŸ“„ è°ƒè¯•å¿«ç…§å·²ä¿å­˜åˆ° debug_content.txt")

                          if file_size < 100:
                              raise Exception(f"âŒ æ–‡ä»¶è¿‡å°ï¼ˆ{file_size}å­—èŠ‚ï¼‰ï¼Œå¯èƒ½æ˜¯é”™è¯¯é¡µé¢")
                          content_sample = page_content[:500].lower()
                          rule_features = ["#", ".", "^", "||", "!", "/"]
                          if not any(feature in content_sample for feature in rule_features):
                              raise Exception(f"âŒ æ–‡ä»¶æ— è§„åˆ™ç‰¹å¾ï¼ˆå‰500å­—ç¬¦ä¸å«{rule_features}ï¼‰ï¼Œå†…å®¹å¯èƒ½æ— æ•ˆ")

                          print(f"âœ… ä¸‹è½½æˆåŠŸï¼æ–‡ä»¶å¤§å°ï¼š{file_size}å­—èŠ‚ï¼ˆçº¦{file_size/1024:.2f}KBï¼‰")
                          return

                  except Exception as e:
                      retry_count += 1
                      print(f"âŒ ç¬¬{retry_count}æ¬¡å°è¯•å¤±è´¥ï¼š{str(e)[:100]}...")
                      if retry_count > max_retries:
                          raise Exception(f"âŒ æ‰€æœ‰{max_retries+1}æ¬¡å°è¯•å‡å¤±è´¥ï¼Œç»ˆæ­¢ä»»åŠ¡") from e
                      time.sleep(3)

          if __name__ == "__main__":
              download_rule(
                  url="${{ env.RULE_URL }}",
                  user_agent="${{ env.USER_AGENT }}",
                  debug_mode="${{ github.event.inputs.debug_mode }}"
              )
          EOF

          python3 download.py || (echo "âŒ ä¸‹è½½è„šæœ¬æ‰§è¡Œå¤±è´¥" && exit 1)

      - name: åŒæ­¥è§„åˆ™åˆ°ç›®æ ‡ä»“åº“
        env:
          GITHUB_TOKEN: ${{ secrets.PANGPANG }}
        run: |
          TARGET_REPO_URL="https://${GITHUB_TOKEN}@github.com/${{ env.TARGET_REPO }}.git"
          LOCAL_TARGET_DIR="target-repo"

          echo -e "\nğŸ”„ åŒæ­¥åˆ°ç›®æ ‡ä»“åº“ï¼š${{ env.TARGET_REPO }}"
          if ! git clone -b main --single-branch "$TARGET_REPO_URL" "$LOCAL_TARGET_DIR"; then
              echo "âš ï¸  ä»“åº“æœªæ‰¾åˆ°ï¼Œåˆå§‹åŒ–æ–°ä»“åº“"
              mkdir -p "$LOCAL_TARGET_DIR"
              cd "$LOCAL_TARGET_DIR" || exit 1
              git init
              git remote add origin "$TARGET_REPO_URL"
              git checkout -b main
              cd ..
          fi

          mkdir -p "$LOCAL_TARGET_DIR/$(dirname ${{ env.TARGET_PATH }})"
          mv -f Gather "$LOCAL_TARGET_DIR/${{ env.TARGET_PATH }}"
          echo "âœ… è§„åˆ™æ–‡ä»¶å·²ç§»åŠ¨åˆ°ï¼š$LOCAL_TARGET_DIR/${{ env.TARGET_PATH }}"

          cd "$LOCAL_TARGET_DIR" || exit 1
          git config --global user.name "GitHub Actions [Gather Sync]"
          git config --global user.email "actions-Gather-sync@github.com"
          
          git add "${{ env.TARGET_PATH }}"
          if git diff --cached --quiet; then
              echo "â„¹ï¸  æ— æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
              exit 0
          fi

          COMMIT_TIME=$(date -d "+8 hours" +'%Y-%m-%d %H:%M:%S')
          git commit -m "Sync Gather rule | Update time: $COMMIT_TIME | Source: ${{ env.RULE_URL }}"
          
          retry=2
          while [ $retry -gt 0 ]; do
              if git push origin main; then
                  echo "âœ… æˆåŠŸæ¨é€åˆ°ç›®æ ‡ä»“åº“ï¼š${{ env.TARGET_REPO }}"
                  break
              fi
              retry=$((retry-1))
              echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œ$retry æ¬¡é‡è¯•æœºä¼š..."
              sleep 2
          done
          if [ $retry -eq 0 ]; then
              echo "âŒ æ¨é€å¤±è´¥ï¼Œæ‰€æœ‰é‡è¯•æœºä¼šç”¨å°½"
              exit 1
          fi
