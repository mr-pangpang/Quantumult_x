name: AdBlock
on:
  schedule:
    - cron: "0 0 * * 1"  # æ¯å‘¨ä¸€ UTC 0 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 8 ç‚¹ï¼‰è‡ªåŠ¨æ‰§è¡Œ
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  download-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–å½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: å®‰è£…PlaywrightåŠChromeï¼ˆé€‚é…Ubuntu 24.04ï¼Œä¿®å¤ä¾èµ–é—®é¢˜ï¼‰
        run: |
          # 1. å®‰è£…å…¼å®¹çš„ç³»ç»Ÿä¾èµ–ï¼ˆåˆ é™¤åºŸå¼ƒçš„libgconf-2-4ï¼Œç”¨libasound2t64æ›¿æ¢libasound2ï¼‰
          sudo apt-get update && sudo apt-get install -y python3-pip libnss3 libxi6 libxrender1 libxss1 libasound2t64
          # 2. å®‰è£…Playwrightå¹¶è‡ªåŠ¨è¡¥å…¨æ‰€æœ‰ä¾èµ–ï¼ˆ--with-depsä¼šå¤„ç†æµè§ˆå™¨æ‰€éœ€åº“ï¼‰
          pip3 install playwright
          playwright install --with-deps
          # 3. æœç´¢Chromeè·¯å¾„ï¼ˆæ‰“å°ç»“æœï¼Œæ–¹ä¾¿è°ƒè¯•ï¼‰
          echo "=== å·²æ‰¾åˆ°çš„æµè§ˆå™¨å¯æ‰§è¡Œæ–‡ä»¶ ==="
          find /home/runner/.cache/ms-playwright/ -name "headless_shell" -o -name "chrome" 2>/dev/null

      - name: ç”¨Playwrightæ¨¡æ‹Ÿæµè§ˆå™¨ä¸‹è½½AdBlockï¼ˆå…¨å±€æ‰¾è·¯å¾„+å…¼å®¹ç³»ç»Ÿï¼‰
        run: |
          cat > download.py << EOF
          from playwright.sync_api import sync_playwright
          import os
          import subprocess

          def find_chrome_path():
              # å…ˆæ‰¾Playwrighté»˜è®¤çš„headless_shellï¼ˆä¼˜å…ˆï¼‰ï¼Œå†æ‰¾chromeï¼ˆå…¼å®¹ä¸åŒç‰ˆæœ¬ï¼‰
              for target in ["headless_shell", "chrome"]:
                  try:
                      # åœ¨Playwrightç¼“å­˜ç›®å½•å†…æœç´¢ç›®æ ‡æ–‡ä»¶
                      result = subprocess.check_output(
                          ["find", "/home/runner/.cache/ms-playwright/", "-name", target],
                          stderr=subprocess.STDOUT
                      ).decode().strip()
                      if result:
                          return result.split("\n")[0]  # è¿”å›ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æœ‰æ•ˆè·¯å¾„
                  except subprocess.CalledProcessError:
                      continue  # æ²¡æ‰¾åˆ°å°±è¯•ä¸‹ä¸€ä¸ªç›®æ ‡
              # éƒ½æ²¡æ‰¾åˆ°åˆ™æŠ¥é”™
              raise Exception("æœªåœ¨Playwrightç¼“å­˜ç›®å½•æ‰¾åˆ°Chrome/headless_shellï¼")

          with sync_playwright() as p:
              # 1. æ‰¾åˆ°Chromeå®é™…è·¯å¾„å¹¶æ‰“å°ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
              chrome_path = find_chrome_path()
              print(f"âœ… å·²æ‰¾åˆ°Chromeè·¯å¾„ï¼š{chrome_path}")

              # 2. å¯åŠ¨Chromeï¼ˆé€‚é…æœåŠ¡å™¨ç¯å¢ƒï¼šæ— æ²™ç®±+å†…å­˜ä¼˜åŒ–ï¼‰
              browser = p.chromium.launch(
                  headless=True,
                  args=["--no-sandbox", "--disable-dev-shm-usage"],  # è§£å†³æœåŠ¡å™¨æ— æƒé™+å†…å­˜ä¸è¶³é—®é¢˜
                  executable_path=chrome_path
              )

              # 3. æ–°å»ºé¡µé¢+è®¾ç½®æµè§ˆå™¨æ ‡è¯†ï¼ˆæ¨¡æ‹Ÿæ­£å¸¸è®¿é—®ï¼‰
              page = browser.new_page(
                  user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
              )

              # 4. ç›‘å¬ä¸‹è½½+è®¿é—®é“¾æ¥ï¼ˆåŠ 30ç§’è¶…æ—¶ï¼Œé¿å…å¡ä½ï¼‰
              print("ğŸ”„ å¼€å§‹è®¿é—®ä¸‹è½½é“¾æ¥...")
              with page.expect_download(timeout=30000) as download_info:
                  page.goto("https://whatshub.top/rule/AntiAD.list", timeout=30000)
              download = download_info.value

              # 5. ä¿å­˜æ–‡ä»¶å¹¶å…³é—­æµè§ˆå™¨
              download.save_as("AdBlock")
              browser.close()
              print("ğŸ”š æµè§ˆå™¨å·²å…³é—­ï¼Œæ–‡ä»¶å¼€å§‹éªŒè¯...")

              # 6. éªŒè¯ä¸‹è½½ç»“æœï¼ˆç¡®ä¿æ–‡ä»¶æœ‰æ•ˆï¼‰
              if not os.path.exists("AdBlock"):
                  raise Exception("âŒ ä¸‹è½½å¤±è´¥ï¼šæœªæ‰¾åˆ°AdBlockæ–‡ä»¶")
              file_size = os.path.getsize("AdBlock")
              if file_size < 100:  # æ’é™¤ç©ºæ–‡ä»¶/æå°æ— æ•ˆæ–‡ä»¶ï¼ˆè§„åˆ™æ–‡ä»¶è‡³å°‘å‡ ç™¾å­—èŠ‚ï¼‰
                  raise Exception(f"âŒ ä¸‹è½½å¤±è´¥ï¼šæ–‡ä»¶è¿‡å°ï¼ˆä»…{file_size}å­—èŠ‚ï¼‰ï¼Œå¯èƒ½æ˜¯é”™è¯¯é¡µé¢")
              print(f"âœ… ä¸‹è½½æˆåŠŸï¼æ–‡ä»¶å¤§å°ï¼š{file_size} å­—èŠ‚ï¼ˆçº¦ {file_size/1024:.2f} KBï¼‰")
          EOF
          # æ‰§è¡Œä¸‹è½½è„šæœ¬
          python3 download.py

      - name: æ£€æŸ¥dpdisk/quantumult_xä»“åº“æ˜¯å¦å­˜åœ¨
        id: check_repo
        run: |
          RESPONSE=$(curl -s -w "%{http_code}" -H "Authorization: token ${{ secrets.PANGPANG }}" "https://api.github.com/repos/dpdisk/quantumult_x")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          echo "repo_exists=$([ "$HTTP_CODE" -eq 200 ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

      - name: è‹¥ä»“åº“ä¸å­˜åœ¨åˆ™åˆ›å»º
        if: steps.check_repo.outputs.repo_exists == 'false'
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.PANGPANG }}" -H "Content-Type: application/json" -d '{"name":"quantumult_x","auto_init":false,"visibility":"public"}' "https://api.github.com/user/repos"

      - name: å…‹éš†dpdisk/quantumult_xä»“åº“
        run: |
          git clone -b main --single-branch https://${{ secrets.PANGPANG }}@github.com/dpdisk/quantumult_x.git target-repo || (mkdir -p target-repo && cd target-repo && git init && git remote add origin https://${{ secrets.PANGPANG }}@github.com/dpdisk/quantumult_x.git && git checkout -b main)

      - name: ç§»åŠ¨æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“æ ¹ç›®å½•
        run: |
          mkdir -p target-repo/filter
          mv AdBlock target-repo/filter/
          echo "æ–‡ä»¶å·²ç§»åŠ¨åˆ°ï¼štarget-repo/filter/AdBlock"

      - name: æäº¤å¹¶æ¨é€dpdiskä»“åº“å˜æ›´
        run: |
          cd target-repo
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add filter/AdBlock
          CURRENT_TIME=$(date -d "+8 hours" +'%Y-%m-%d %H:%M:%S')  # ç”¨åŒ—äº¬æ—¶é—´ä½œä¸ºæäº¤æ—¶é—´
          git commit -m "updatetime $CURRENT_TIME" || echo "æ— æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤"
          git push https://${{ secrets.PANGPANG }}@github.com/dpdisk/quantumult_x.git HEAD:main
